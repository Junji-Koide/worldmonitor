---
phase: 04-global-map-positive-events
plan: 02
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - src/services/positive-events-geo.ts
  - src/components/DeckGLMap.ts
  - src/App.ts
autonomous: true
requirements: [MAP-01, MAP-02]

must_haves:
  truths:
    - "The map displays geocoded positive news events as green/gold pulsing markers on the happy variant"
    - "Positive events are geolocated from two sources: GDELT GEO API (server-side) and RSS geocoding via inferGeoHubsFromTitle"
    - "Clicking a positive event marker shows a tooltip with name, category, and report count"
    - "Positive events layer respects the positiveEvents toggle (can be turned off)"
    - "Data loads asynchronously without blocking the initial map render"
  artifacts:
    - path: "src/services/positive-events-geo.ts"
      provides: "Client-side service fetching geocoded positive events from GDELT GEO API + RSS geocoding"
      exports: ["fetchPositiveGeoEvents", "PositiveGeoEvent"]
    - path: "src/components/DeckGLMap.ts"
      provides: "createPositiveEventsLayers method, tooltip case, setter, buildLayers wiring"
      contains: "createPositiveEventsLayers"
    - path: "src/App.ts"
      provides: "Happy variant data loading that calls fetchPositiveGeoEvents and sets map data"
      contains: "setPositiveEvents"
  key_links:
    - from: "src/services/positive-events-geo.ts"
      to: "src/components/DeckGLMap.ts"
      via: "App.ts calls fetchPositiveGeoEvents() then map.setPositiveEvents()"
      pattern: "setPositiveEvents"
    - from: "src/components/DeckGLMap.ts"
      to: "buildLayers"
      via: "mapLayers.positiveEvents check gates createPositiveEventsLayers()"
      pattern: "mapLayers\\.positiveEvents"
---

<objective>
Build the positive events geocoding pipeline and Deck.gl map layer so users see green/gold pulsing markers at locations of positive news stories.

Purpose: MAP-01 and MAP-02 -- the core value proposition of Phase 4. Positive news events become spatial, showing WHERE good things happen.
Output: Working positive events layer on happy map with GDELT GEO data + RSS geocoding.
</objective>

<execution_context>
@/Users/sebastienmelki/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastienmelki/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-global-map-positive-events/04-RESEARCH.md
@.planning/phases/04-global-map-positive-events/04-01-SUMMARY.md
@src/components/DeckGLMap.ts (lines 2107-2167 -- createHotspotsLayers pulse pattern)
@src/components/DeckGLMap.ts (lines 2255-2327 -- createNewsLocationsLayer pattern)
@src/components/DeckGLMap.ts (lines 2329-2380 -- getTooltip switch)
@src/components/DeckGLMap.ts (lines 913-970 -- buildLayers layer checks)
@src/components/DeckGLMap.ts (lines 3340-3400 -- setter methods: setNewsLocations pattern)
@src/components/DeckGLMap.ts (lines 2192-2254 -- pulse animation: pulseTime, syncPulseAnimation)
@server/worldmonitor/unrest/v1/list-unrest-events.ts (lines 108-180 -- GDELT GEO fetch pattern)
@src/services/geo-hub-index.ts (inferGeoHubsFromTitle)
@src/services/positive-classifier.ts (HappyContentCategory, classifyNewsItem)
@src/services/gdelt-intel.ts (POSITIVE_GDELT_TOPICS)
@src/App.ts (lines 3170-3205 -- loadData task pipeline)
@src/App.ts (lines 3590-3635 -- loadHappySupplementaryAndRender pipeline)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create positive-events-geo service and DeckGLMap positive events layer</name>
  <files>
    src/services/positive-events-geo.ts
    src/components/DeckGLMap.ts
  </files>
  <action>
**1. Create `src/services/positive-events-geo.ts`:**

Export interface and fetch function:

```typescript
export interface PositiveGeoEvent {
  lat: number;
  lon: number;
  name: string;
  category: HappyContentCategory;
  count: number;
  timestamp: number;
}
```

Export `fetchPositiveGeoEvents(): Promise<PositiveGeoEvent[]>` that:
- Fetches GDELT GEO 2.0 API **client-side directly** (same as the protest fetch in DeckGLMap does -- NOT via server RPC, since GDELT GEO is a public unauthenticated API). Use `https://api.gdeltproject.org/api/v2/geo/geo` with `format=geojson`.
- Runs 3-4 positive topic queries (from `POSITIVE_GDELT_TOPICS` pattern in gdelt-intel.ts): breakthrough/discovery, renewable energy, conservation success, poverty decline. Combine with OR operators into 2 compound queries to minimize API calls (GDELT rate limit concern per pitfall #2).
- For each query: `timespan=24h`, `maxrecords=75`, `format=geojson`.
- Parse GeoJSON features: extract `[lon, lat]` from `geometry.coordinates`, `name` from `properties.name`, `count` from `properties.count`.
- Filter: skip if `count < 3` (noise filter), skip if invalid coordinates.
- Deduplicate by location name (same pattern as unrest handler line 128-132).
- Classify each event using `classifyNewsItem('GDELT', name)` from positive-classifier.ts.
- Set `timestamp` to `Date.now()` (GDELT GEO doesn't return per-feature timestamps).
- Add 500ms delay between the 2 compound queries to respect rate limits.
- Wrap entire function in try/catch returning `[]` on failure (graceful degradation).

Also export `geocodePositiveNewsItems(items: Array<{ title: string; category?: HappyContentCategory }>): PositiveGeoEvent[]` that:
- Takes the existing curated RSS items (which have titles from Phase 2/3).
- Calls `inferGeoHubsFromTitle(item.title)` for each item.
- For items with geo matches, creates a `PositiveGeoEvent` with the first match's lat/lon, the item title as name, the item's category (default 'humanity-kindness'), count=1, timestamp=Date.now().
- Returns only items that successfully geocoded (not all RSS items have location mentions).

**2. Update `src/components/DeckGLMap.ts`:**

a) Add private field: `private positiveEvents: PositiveGeoEvent[] = [];` near the other data arrays (line ~271 area).

b) Add `createPositiveEventsLayers(): Layer[]` method following the exact hotspots pulse pattern (lines 2107-2167):
   - **Solid fill layer** (`id: 'positive-events-layer'`):
     - `data: this.positiveEvents`
     - `getPosition: (d) => [d.lon, d.lat]`
     - `getRadius: 15000`
     - `getFillColor`: green `[34, 197, 94, 180]` for nature-wildlife and humanity-kindness categories; gold `[234, 179, 8, 180]` for science-health, innovation-tech, climate-wins; purple `[139, 92, 246, 180]` for culture-community.
     - `radiusMinPixels: 4`, `radiusMaxPixels: 14`
     - `pickable: true`
   - **Pulse ring layer** (`id: 'positive-events-pulse'`):
     - Only for events where `count > 10` (significant events pulse).
     - `radiusScale`: use `1.0 + 0.6 * (0.5 + 0.5 * Math.sin((this.pulseTime || Date.now()) / 500))` (slower than hotspots' 400ms period -- calmer feel).
     - `stroked: true, filled: false`
     - `getLineColor: [34, 197, 94, 100]` (green glow)
     - `lineWidthMinPixels: 1.5`
     - `updateTriggers: { radiusScale: this.pulseTime }`

c) Add tooltip case in `getTooltip()` switch (after existing cases):
```typescript
case 'positive-events-layer':
  return { html: `<div class="deckgl-tooltip"><strong>${text(obj.name)}</strong><br/>${text(obj.category ? obj.category.replace('-', ' & ') : 'Positive Event')}${obj.count > 1 ? ` &bull; ${obj.count} reports` : ''}</div>` };
```

d) In `buildLayers()`, add after the existing layer checks (near the end, before the news locations section):
```typescript
if (mapLayers.positiveEvents && this.positiveEvents.length > 0) {
  layers.push(...this.createPositiveEventsLayers());
}
```

e) Add public setter:
```typescript
public setPositiveEvents(events: PositiveGeoEvent[]): void {
  this.positiveEvents = events;
  this.syncPulseAnimation();
  this.render();
}
```

f) Import `PositiveGeoEvent` type at top of file from `../services/positive-events-geo`.
  </action>
  <verify>Run `npx tsc --noEmit` from project root. Zero TypeScript errors. Verify `grep -c 'createPositiveEventsLayers' src/components/DeckGLMap.ts` returns at least 2 (definition + call in buildLayers).</verify>
  <done>DeckGLMap has a working positive events layer with green/gold markers, pulse animation for high-count events, tooltip, and setter. The service fetches from GDELT GEO API + geocodes RSS items.</done>
</task>

<task type="auto">
  <name>Task 2: Wire positive events loading into App.ts happy variant pipeline</name>
  <files>src/App.ts</files>
  <action>
1. Import at top of App.ts:
```typescript
import { fetchPositiveGeoEvents, geocodePositiveNewsItems } from './services/positive-events-geo';
```

2. In the `loadData()` method (around line 3177), add a new task for happy variant AFTER the natural layer task:
```typescript
if (SITE_VARIANT === 'happy' && this.mapLayers.positiveEvents) {
  tasks.push({ name: 'positiveEvents', task: runGuarded('positiveEvents', () => this.loadPositiveEvents()) });
}
```

3. Create a new private method `loadPositiveEvents()`:
```typescript
private async loadPositiveEvents(): Promise<void> {
  // Source 1: GDELT GEO API positive queries
  const gdeltEvents = await fetchPositiveGeoEvents();

  // Source 2: Geocode curated RSS items from the happy pipeline
  const rssEvents = geocodePositiveNewsItems(
    this.happyAllItems.map(item => ({
      title: item.title,
      category: item.happyCategory,
    }))
  );

  // Merge both sources, deduplicate by name
  const seen = new Set<string>();
  const merged = [...gdeltEvents, ...rssEvents].filter(e => {
    if (seen.has(e.name)) return false;
    seen.add(e.name);
    return true;
  });

  this.map?.setPositiveEvents(merged);
}
```

4. In `loadDataForLayer()` switch statement (around line 3207-3250), add a case:
```typescript
case 'positiveEvents':
  await this.loadPositiveEvents();
  break;
```

This ensures toggling the positiveEvents layer on triggers data loading.
  </action>
  <verify>Run `npx tsc --noEmit` from project root. Zero TypeScript errors. Verify `grep -c 'loadPositiveEvents' src/App.ts` returns at least 3 (definition + 2 call sites).</verify>
  <done>Happy variant loads positive geo events from GDELT GEO API + geocoded RSS items on startup and on layer toggle, and pushes them to the map for rendering as green/gold markers.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `grep -c 'PositiveGeoEvent' src/services/positive-events-geo.ts` returns at least 3
3. `grep -c 'createPositiveEventsLayers' src/components/DeckGLMap.ts` returns at least 2
4. `grep -c 'positive-events-layer' src/components/DeckGLMap.ts` returns at least 2 (layer + tooltip)
5. `grep -c 'loadPositiveEvents' src/App.ts` returns at least 3
6. `grep -c 'setPositiveEvents' src/components/DeckGLMap.ts` returns at least 1
</verification>

<success_criteria>
- Positive events service fetches from GDELT GEO API with positive queries and geocodes RSS items
- DeckGLMap renders green/gold ScatterplotLayer markers with pulse animation for significant events
- Tooltip shows event name, category, and count on hover
- App.ts loads positive events for happy variant in loadData() and on layer toggle
- Data loads asynchronously without blocking map render
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/04-global-map-positive-events/04-02-SUMMARY.md`
</output>

---
phase: 04-global-map-positive-events
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/index.ts
  - src/config/panels.ts
  - src/config/variants/happy.ts
  - src/components/DeckGLMap.ts
autonomous: true
requirements: [MAP-01]

must_haves:
  truths:
    - "MapLayers interface includes positiveEvents and kindness boolean keys"
    - "All 10 variant layer configs compile with the new keys (8 in panels.ts + 2 in happy.ts)"
    - "Happy variant layer toggles show Positive Events, Acts of Kindness, and Natural Events"
    - "Happy variant legend shows green/gold/kindness marker entries instead of threat markers"
  artifacts:
    - path: "src/types/index.ts"
      provides: "positiveEvents and kindness keys on MapLayers interface"
      contains: "positiveEvents: boolean"
    - path: "src/config/panels.ts"
      provides: "All 8 variant configs updated with new keys"
      contains: "positiveEvents"
    - path: "src/config/variants/happy.ts"
      provides: "Happy variant desktop + mobile configs with positiveEvents and kindness enabled"
      contains: "positiveEvents: true"
    - path: "src/components/DeckGLMap.ts"
      provides: "Happy variant layer toggle config and legend items"
      contains: "positiveEvents"
  key_links:
    - from: "src/types/index.ts"
      to: "src/config/panels.ts"
      via: "MapLayers interface constrains all variant configs"
      pattern: "MapLayers"
    - from: "src/config/panels.ts"
      to: "src/components/DeckGLMap.ts"
      via: "DEFAULT_MAP_LAYERS drives layer toggle + buildLayers checks"
      pattern: "mapLayers\\.positiveEvents"
---

<objective>
Add positiveEvents and kindness map layer keys to the type system, update all variant configs, and wire happy variant layer toggles + legend.

Purpose: Foundation for Phase 4 -- without these keys, no layer can be toggled or rendered. Every downstream plan depends on these config entries existing.
Output: Compiling MapLayers with 2 new keys, happy variant toggle panel, happy variant legend.
</objective>

<execution_context>
@/Users/sebastienmelki/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sebastienmelki/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-global-map-positive-events/04-RESEARCH.md
@src/types/index.ts (lines 486-526 -- MapLayers interface)
@src/config/panels.ts (lines 50-484 -- all 8 variant layer configs + LAYER_TO_SOURCE)
@src/config/variants/happy.ts (lines 19-80 -- happy variant desktop + mobile layer configs)
@src/components/DeckGLMap.ts (lines 2760-2834 -- createLayerToggles)
@src/components/DeckGLMap.ts (lines 3021-3065 -- createLegend)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add positiveEvents and kindness to MapLayers and update all variant configs</name>
  <files>
    src/types/index.ts
    src/config/panels.ts
    src/config/variants/happy.ts
  </files>
  <action>
1. In `src/types/index.ts`, add two new keys to the `MapLayers` interface after the Gulf FDI section (line ~526):
```typescript
  // Happy variant layers
  positiveEvents: boolean;
  kindness: boolean;
```

2. In `src/config/panels.ts`, add `positiveEvents: false, kindness: false` to ALL 8 variant configs:
   - `FULL_MAP_LAYERS` (line ~50)
   - `FULL_MOBILE_MAP_LAYERS` (line ~91)
   - `TECH_MAP_LAYERS` (line ~172)
   - `TECH_MOBILE_MAP_LAYERS` (line ~213)
   - `FINANCE_MAP_LAYERS` (line ~289)
   - `FINANCE_MOBILE_MAP_LAYERS` (line ~330)
   - `HAPPY_MAP_LAYERS` (line ~383) -- set `positiveEvents: true, kindness: true`
   - `HAPPY_MOBILE_MAP_LAYERS` (line ~424) -- set `positiveEvents: true, kindness: true`
   Place them in a new `// Happy variant layers` comment section after `gulfInvestments` in each config.

3. In `src/config/variants/happy.ts`, add `positiveEvents: true, kindness: true` to both `DEFAULT_MAP_LAYERS` (desktop) and `MOBILE_DEFAULT_MAP_LAYERS` objects with a `// Happy variant layers` comment.

4. Do NOT add entries to `LAYER_TO_SOURCE` yet -- that will be done in Plan 02/03 when data sources are created.
  </action>
  <verify>Run `npx tsc --noEmit` from project root. Zero TypeScript errors (all MapLayers object literals satisfy the extended interface).</verify>
  <done>All 10 MapLayers configs compile. Happy desktop+mobile have positiveEvents:true and kindness:true. All non-happy configs have both keys set to false.</done>
</task>

<task type="auto">
  <name>Task 2: Add happy variant layer toggles and legend in DeckGLMap</name>
  <files>src/components/DeckGLMap.ts</files>
  <action>
1. In `createLayerToggles()` (line ~2760), the layerConfig ternary currently has `SITE_VARIANT === 'tech'`, `SITE_VARIANT === 'finance'`, then a default (full variant). Insert a new `SITE_VARIANT === 'happy'` branch BEFORE the default fallthrough. The happy branch should contain:
```typescript
SITE_VARIANT === 'happy'
  ? [
      { key: 'positiveEvents', label: 'Positive Events', icon: '&#127775;' },
      { key: 'kindness', label: 'Acts of Kindness', icon: '&#128154;' },
      { key: 'natural', label: t('components.deckgl.layers.naturalEvents'), icon: '&#127755;' },
    ]
```
Use hardcoded English labels for `positiveEvents` and `kindness` (no i18n keys exist yet -- consistent with how happy variant strings are handled in Phase 3). Reuse the existing `t()` call for natural events.

2. In `createLegend()` (line ~3021), the legendItems ternary has tech, finance, then default. Insert a `SITE_VARIANT === 'happy'` branch BEFORE the default:
```typescript
SITE_VARIANT === 'happy'
  ? [
      { shape: shapes.circle('rgb(34, 197, 94)'), label: 'Positive Event' },
      { shape: shapes.circle('rgb(234, 179, 8)'), label: 'Breakthrough' },
      { shape: shapes.circle('rgb(74, 222, 128)'), label: 'Act of Kindness' },
      { shape: shapes.circle('rgb(255, 100, 50)'), label: 'Natural Event' },
    ]
```
Colors match happy theme: green for positive, gold for breakthrough, light green for kindness, orange for natural (matches existing earthquake marker).
  </action>
  <verify>Run `npx tsc --noEmit` from project root. Zero TypeScript errors. Verify the happy branch appears in both createLayerToggles and createLegend by searching for 'positiveEvents' in DeckGLMap.ts.</verify>
  <done>Happy variant shows 3 toggle buttons (Positive Events, Acts of Kindness, Natural Events) and a 4-item legend with warm colors. Non-happy variants are unchanged.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `grep -c 'positiveEvents' src/types/index.ts` returns 1
3. `grep -c 'positiveEvents' src/config/panels.ts` returns 10 (8 configs + 2 in export lines)
4. `grep -c 'positiveEvents' src/config/variants/happy.ts` returns 2
5. `grep -c 'positiveEvents' src/components/DeckGLMap.ts` returns at least 2 (toggle + legend)
</verification>

<success_criteria>
- MapLayers interface has positiveEvents and kindness boolean keys
- All 10 variant layer configs (8 panels.ts + 2 happy.ts) compile with new keys
- Happy variant: positiveEvents=true, kindness=true; all others: both false
- DeckGLMap createLayerToggles has happy branch with 3 toggles
- DeckGLMap createLegend has happy branch with 4 legend items
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/04-global-map-positive-events/04-01-SUMMARY.md`
</output>
